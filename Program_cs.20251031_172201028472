using System;
using System.Linq;
using System.Runtime.InteropServices;
using System.Net.Http;
using System.Text;
using System.Threading.Tasks;
using Microsoft.Win32;

class ProxyManager
{
    private const string ProxyRegistryPath = @"Software\Microsoft\Windows\CurrentVersion\Internet Settings";

    // Windows API to notify system
    [DllImport("wininet.dll", SetLastError = true)]
    private static extern bool InternetSetOption(IntPtr hInternet, int dwOption, IntPtr lpBuffer, int dwBufferLength);

    private const int INTERNET_OPTION_SETTINGS_CHANGED = 39;
    private const int INTERNET_OPTION_REFRESH = 37;

    // Growl settings (customize as needed)
    private const string GrowlHost = "localhost";
    private const int GrowlPort = 23053;

    static async Task Main(string[] args)
    {
        // Argument mode
        if (args.Length > 0)
        {
            await HandleArgumentsAsync(args);
            return;
        }

        // Interactive mode
        await InteractiveModeAsync();
    }

    static async Task HandleArgumentsAsync(string[] args)
    {
        string command = args[0].ToLower();

        switch (command)
        {
            case "check":
            case "status":
                CheckProxyStatus();
                break;

            case "get":
            case "show":
                GetProxySettings();
                break;

            case "set":
                if (args.Length < 2)
                {
                    PrintError("âŒ Format: dotnet run set <proxy_server> [bypass_list]");
                    PrintInfo("ğŸ’¡ Example: dotnet run set 127.0.0.1:8080");
                    PrintInfo("ğŸ’¡ Example: dotnet run set 127.0.0.1:8080 \"<local>;*.example.com\"");
                    return;
                }
                string proxyServer = args[1];
                string? bypassList = args.Length > 2 ? args[2] : null;
                await SetProxyWithArgsAsync(proxyServer, bypassList);
                break;

            case "disable":
            case "off":
                await DisableProxyAsync();
                break;

            case "bypass":
                if (args.Length < 2)
                {
                    PrintError("âŒ Format: dotnet run bypass <action> [value]");
                    PrintInfo("ğŸ’¡ Actions: set, add, remove, clear, show");
                    PrintInfo("ğŸ’¡ Example: dotnet run bypass set \"<local>;*.internal.com\"");
                    PrintInfo("ğŸ’¡ Example: dotnet run bypass add \"*.example.com\"");
                    PrintInfo("ğŸ’¡ Example: dotnet run bypass remove \"*.example.com\"");
                    PrintInfo("ğŸ’¡ Example: dotnet run bypass clear");
                    PrintInfo("ğŸ’¡ Example: dotnet run bypass show");
                    return;
                }
                string bypassAction = args[1].ToLower();
                string? bypassValue = args.Length > 2 ? args[2] : null;
                await HandleBypassCommandAsync(bypassAction, bypassValue);
                break;

            case "help":
            case "-h":
            case "--help":
                ShowHelp();
                break;

            default:
                PrintError($"âŒ Unknown command: {command}");
                ShowHelp();
                break;
        }
    }

    static void ShowHelp()
    {
        PrintHeader("ğŸ”§ Windows Proxy Manager - Help");
        Console.WriteLine();
        PrintSuccess("Interactive Mode (no arguments):");
        Console.WriteLine("  dotnet run");
        Console.WriteLine();
        PrintSuccess("Command Line Mode:");
        Console.WriteLine("  dotnet run check              ğŸ” Check proxy status");
        Console.WriteLine("  dotnet run get                ğŸ“‹ Show proxy settings");
        Console.WriteLine("  dotnet run set <server>       âš™ï¸  Set proxy server");
        Console.WriteLine("  dotnet run set <server> <bypass>  Set proxy with bypass list");
        Console.WriteLine("  dotnet run disable            â›” Disable proxy");
        Console.WriteLine("  dotnet run bypass <action>    ğŸš« Manage bypass list");
        Console.WriteLine("  dotnet run help               ğŸ“– Show help");
        Console.WriteLine();
        PrintSuccess("Bypass List Actions:");
        Console.WriteLine("  dotnet run bypass show        ğŸ“‹ Show current bypass list");
        Console.WriteLine("  dotnet run bypass set <list>  âš™ï¸  Set/replace bypass list");
        Console.WriteLine("  dotnet run bypass add <item>  â• Add item to bypass list");
        Console.WriteLine("  dotnet run bypass remove <item> â– Remove item from bypass list");
        Console.WriteLine("  dotnet run bypass clear       ğŸ—‘ï¸  Clear all bypass list");
        Console.WriteLine();
        PrintInfo("ğŸ’¡ Examples:");
        Console.ForegroundColor = ConsoleColor.Cyan;
        Console.WriteLine("  dotnet run set 127.0.0.1:8080");
        Console.WriteLine("  dotnet run set 192.168.1.100:3128 \"<local>;*.internal.com\"");
        Console.WriteLine("  dotnet run check");
        Console.WriteLine("  dotnet run disable");
        Console.WriteLine("  dotnet run bypass add \"*.example.com\"");
        Console.WriteLine("  dotnet run bypass remove \"<local>\"");
        Console.ResetColor();
    }

    static async Task InteractiveModeAsync()
    {
        PrintHeader("ğŸŒ Windows Proxy Manager");
        
        while (true)
        {
            Console.WriteLine();
            PrintSuccess("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
            PrintSuccess("â•‘     Choose Operation:        â•‘");
            PrintSuccess("â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£");
            Console.WriteLine("â•‘  1ï¸âƒ£  Check Proxy Status      â•‘");
            Console.WriteLine("â•‘  2ï¸âƒ£  Get Proxy Settings      â•‘");
            Console.WriteLine("â•‘  3ï¸âƒ£  Set Proxy               â•‘");
            Console.WriteLine("â•‘  4ï¸âƒ£  Disable Proxy           â•‘");
            Console.WriteLine("â•‘  5ï¸âƒ£  Manage Bypass List      â•‘");
            Console.WriteLine("â•‘  6ï¸âƒ£  Exit                    â•‘");
            PrintSuccess("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
            Console.Write("\nğŸ‘‰ Your choice (1-6): ");

            string? choice = Console.ReadLine();

            switch (choice)
            {
                case "1":
                    CheckProxyStatus();
                    break;
                case "2":
                    GetProxySettings();
                    break;
                case "3":
                    await SetProxyInteractiveAsync();
                    break;
                case "4":
                    await DisableProxyAsync();
                    break;
                case "5":
                    await ManageBypassListInteractiveAsync();
                    break;
                case "6":
                    PrintSuccess("\nğŸ‘‹ Thank you for using Proxy Manager!");
                    return;
                default:
                    PrintError("âŒ Invalid choice!");
                    break;
            }
        }
    }

    static void CheckProxyStatus()
    {
        try
        {
            Console.WriteLine();
            PrintHeader("ğŸ” Checking Proxy Status");

            using RegistryKey? key = Registry.CurrentUser.OpenSubKey(ProxyRegistryPath);
            
            if (key == null)
            {
                PrintError("âŒ Cannot access proxy registry");
                return;
            }

            object? proxyEnable = key.GetValue("ProxyEnable");
            object? proxyServer = key.GetValue("ProxyServer");
            object? proxyOverride = key.GetValue("ProxyOverride");

            bool isEnabled = proxyEnable != null && (int)proxyEnable == 1;

            Console.WriteLine();
            Console.WriteLine("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
            if (isEnabled)
            {
                PrintSuccess("â•‘       âœ… STATUS: ACTIVE                         â•‘");
            }
            else
            {
                PrintWarning("â•‘       â›” STATUS: INACTIVE                       â•‘");
            }
            Console.WriteLine("â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£");
            
            if (proxyServer != null && !string.IsNullOrWhiteSpace(proxyServer.ToString()))
            {
                Console.ForegroundColor = ConsoleColor.Cyan;
                Console.WriteLine($"â•‘  ğŸŒ Server : {proxyServer,-35}â•‘");
                Console.WriteLine($"â•‘  ğŸš« Bypass : {(proxyOverride?.ToString() ?? "(not set)"),-35}â•‘");
                Console.ResetColor();
            }
            else
            {
                Console.ForegroundColor = ConsoleColor.Gray;
                Console.WriteLine("â•‘  No proxy configured                           â•‘");
                Console.ResetColor();
            }
            
            Console.WriteLine("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
        }
        catch (Exception ex)
        {
            PrintError($"âŒ Error: {ex.Message}");
        }
    }

    static void GetProxySettings()
    {
        try
        {
            Console.WriteLine();
            PrintHeader("ğŸ“‹ Proxy Settings");

            using RegistryKey? key = Registry.CurrentUser.OpenSubKey(ProxyRegistryPath);
            
            if (key == null)
            {
                PrintError("âŒ Cannot access proxy registry");
                return;
            }

            object? proxyEnable = key.GetValue("ProxyEnable");
            object? proxyServer = key.GetValue("ProxyServer");
            object? proxyOverride = key.GetValue("ProxyOverride");

            bool isEnabled = proxyEnable != null && (int)proxyEnable == 1;

            Console.WriteLine();
            Console.WriteLine("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
            
            if (isEnabled)
            {
                PrintSuccess("â•‘  ğŸ“Š Status      : âœ… Active                     â•‘");
            }
            else
            {
                PrintWarning("â•‘  ğŸ“Š Status      : â›” Inactive                   â•‘");
            }
            
            Console.ForegroundColor = ConsoleColor.Cyan;
            string server = proxyServer?.ToString() ?? "(not set)";
            string bypass = proxyOverride?.ToString() ?? "(not set)";
            Console.WriteLine($"â•‘  ğŸŒ Server      : {server,-30}â•‘");
            Console.WriteLine($"â•‘  ğŸš« Bypass List : {bypass,-30}â•‘");
            Console.ResetColor();
            Console.WriteLine("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
        }
        catch (Exception ex)
        {
            PrintError($"âŒ Error: {ex.Message}");
        }
    }

    static async Task SetProxyInteractiveAsync()
    {
        Console.WriteLine();
        PrintHeader("âš™ï¸  Set Proxy Configuration");
        
        Console.Write("\nğŸŒ Enter proxy server (example: 127.0.0.1:8080): ");
        string? proxyServer = Console.ReadLine();

        if (string.IsNullOrWhiteSpace(proxyServer))
        {
            PrintError("âŒ Proxy server cannot be empty!");
            return;
        }

        Console.Write("ğŸš« Bypass list (separate with ; or Enter for default): ");
        string? bypassList = Console.ReadLine();

        await SetProxyCoreAsync(proxyServer, bypassList);
    }

    static async Task SetProxyWithArgsAsync(string proxyServer, string? bypassList)
    {
        Console.WriteLine();
        PrintHeader("âš™ï¸  Setting Proxy");
        await SetProxyCoreAsync(proxyServer, bypassList);
    }

    static async Task SetProxyCoreAsync(string proxyServer, string? bypassList)
    {
        try
        {
            using RegistryKey? key = Registry.CurrentUser.OpenSubKey(ProxyRegistryPath, true);
            
            if (key == null)
            {
                PrintError("âŒ Cannot access proxy registry");
                return;
            }

            // Set proxy server
            key.SetValue("ProxyServer", proxyServer);
            
            // Set bypass list only if provided
            if (!string.IsNullOrWhiteSpace(bypassList))
            {
                key.SetValue("ProxyOverride", bypassList);
            }
            else
            {
                // Remove bypass list if empty
                key.DeleteValue("ProxyOverride", false);
                bypassList = "(none)";
            }
            
            // Enable proxy
            key.SetValue("ProxyEnable", 1, RegistryValueKind.DWord);

            Console.WriteLine();
            Console.WriteLine("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
            PrintSuccess("â•‘       âœ… PROXY ACTIVATED!                       â•‘");
            Console.WriteLine("â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£");
            Console.ForegroundColor = ConsoleColor.Cyan;
            Console.WriteLine($"â•‘  ğŸŒ Server : {proxyServer,-35}â•‘");
            Console.WriteLine($"â•‘  ğŸš« Bypass : {bypassList,-35}â•‘");
            Console.ResetColor();
            Console.WriteLine("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");

            // Notify system
            Console.WriteLine();
            PrintInfo("â³ Notifying system...");
            if (NotifyProxyChange())
            {
                PrintSuccess("âœ… System notified successfully! ğŸš€");
            }

            // Send notifications
            await SendNotificationsAsync("Bypass List Cleared", "All bypass entries removed");
        }
        catch (Exception ex)
        {
            PrintError($"âŒ Error: {ex.Message}");
        }
    }

    static async Task SendNotificationsAsync(string title, string message)
    {
        // Try Windows Notification
        bool windowsNotifSuccess = await SendWindowsNotificationAsync(title, message);
        
        // Try Growl Notification
        bool growlNotifSuccess = await SendGrowlNotificationAsync(title, message);

        // Show notification status
        if (!windowsNotifSuccess && !growlNotifSuccess)
        {
            PrintWarning("âš ï¸  Desktop notifications unavailable");
        }
    }

    static async Task<bool> SendWindowsNotificationAsync(string title, string message)
    {
        try
        {
            // Use PowerShell to send Windows Toast Notification
            var psi = new System.Diagnostics.ProcessStartInfo
            {
                FileName = "powershell.exe",
                Arguments = $@"-NoProfile -ExecutionPolicy Bypass -Command ""
                    [Windows.UI.Notifications.ToastNotificationManager, Windows.UI.Notifications, ContentType = WindowsRuntime] | Out-Null;
                    [Windows.Data.Xml.Dom.XmlDocument, Windows.Data.Xml.Dom.XmlDocument, ContentType = WindowsRuntime] | Out-Null;
                    $template = @'
                    <toast>
                        <visual>
                            <binding template='ToastGeneric'>
                                <text>{title}</text>
                                <text>{message}</text>
                            </binding>
                        </visual>
                    </toast>
                    '@;
                    $xml = New-Object Windows.Data.Xml.Dom.XmlDocument;
                    $xml.LoadXml($template);
                    $toast = [Windows.UI.Notifications.ToastNotification]::new($xml);
                    $notifier = [Windows.UI.Notifications.ToastNotificationManager]::CreateToastNotifier('Proxy Manager');
                    $notifier.Show($toast);
                """,
                UseShellExecute = false,
                CreateNoWindow = true,
                RedirectStandardOutput = true,
                RedirectStandardError = true
            };

            using var process = System.Diagnostics.Process.Start(psi);
            if (process != null)
            {
                await process.WaitForExitAsync();
                return process.ExitCode == 0;
            }
            return false;
        }
        catch (Exception ex)
        {
            // Silently fail - notification is not critical
            System.Diagnostics.Debug.WriteLine($"Windows notification failed: {ex.Message}");
            return false;
        }
    }

    static async Task<bool> SendGrowlNotificationAsync(string title, string message)
    {
        try
        {
            using var client = new HttpClient();
            client.Timeout = TimeSpan.FromSeconds(2);

            // Growl GNTP protocol (simple notification)
            var growlData = new
            {
                application = "Proxy Manager",
                title = title,
                message = message,
                priority = 0
            };

            var json = System.Text.Json.JsonSerializer.Serialize(growlData);
            var content = new StringContent(json, Encoding.UTF8, "application/json");

            // Try to send to Growl HTTP API (if available)
            var response = await client.PostAsync($"http://{GrowlHost}:{GrowlPort}/notify", content);
            return response.IsSuccessStatusCode;
        }
        catch (Exception ex)
        {
            // Silently fail - Growl might not be installed
            System.Diagnostics.Debug.WriteLine($"Growl notification failed: {ex.Message}");
            return false;
        }
    }
            {
                PrintSuccess("âœ… System notified successfully! ğŸš€");
            }
            else
            {
                PrintWarning("âš ï¸  Failed to notify system");
            }

            // Send notifications
            await SendNotificationsAsync("Proxy Activated", $"Server: {proxyServer}\nBypass: {bypassList}");
        }
        catch (Exception ex)
        {
            PrintError($"âŒ Error: {ex.Message}");
        }
    }

    static async Task DisableProxyAsync()
    {
        try
        {
            Console.WriteLine();
            PrintHeader("â›” Disabling Proxy");

            using RegistryKey? key = Registry.CurrentUser.OpenSubKey(ProxyRegistryPath, true);
            
            if (key == null)
            {
                PrintError("âŒ Cannot access proxy registry");
                return;
            }

            // Get current proxy before disabling
            object? proxyServer = key.GetValue("ProxyServer");
            object? proxyOverride = key.GetValue("ProxyOverride");

            // Disable proxy
            key.SetValue("ProxyEnable", 0, RegistryValueKind.DWord);

            Console.WriteLine();
            Console.WriteLine("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
            PrintSuccess("â•‘       âœ… PROXY DISABLED!                        â•‘");
            Console.WriteLine("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");

            // Notify system
            Console.WriteLine();
            PrintInfo("â³ Notifying system...");
            if (NotifyProxyChange())
            {
                PrintSuccess("âœ… System notified successfully! ğŸš€");
            }
            else
            {
                PrintWarning("âš ï¸  Failed to notify system");
            }

            // Send notifications
            string serverInfo = proxyServer != null ? proxyServer.ToString()! : "None";
            await SendNotificationsAsync("Proxy Disabled", $"Previously: {serverInfo}");
        }
        catch (Exception ex)
        {
            PrintError($"âŒ Error: {ex.Message}");
        }
    }

    static bool NotifyProxyChange()
    {
        try
        {
            // INTERNET_OPTION_SETTINGS_CHANGED: notify that settings changed
            InternetSetOption(IntPtr.Zero, INTERNET_OPTION_SETTINGS_CHANGED, IntPtr.Zero, 0);
            
            // INTERNET_OPTION_REFRESH: refresh settings
            InternetSetOption(IntPtr.Zero, INTERNET_OPTION_REFRESH, IntPtr.Zero, 0);
            
            return true;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"âš ï¸  Notify error: {ex.Message}");
            return false;
        }
    }

    static async Task HandleBypassCommandAsync(string action, string? value)
    {
        switch (action)
        {
            case "show":
                ShowBypassList();
                break;
            case "set":
                if (string.IsNullOrWhiteSpace(value))
                {
                    PrintError("âŒ Value required for 'set' action");
                    PrintInfo("ğŸ’¡ Example: dotnet run bypass set \"<local>;*.internal.com\"");
                    return;
                }
                await SetBypassListAsync(value);
                break;
            case "add":
                if (string.IsNullOrWhiteSpace(value))
                {
                    PrintError("âŒ Value required for 'add' action");
                    PrintInfo("ğŸ’¡ Example: dotnet run bypass add \"*.example.com\"");
                    return;
                }
                await AddToBypassListAsync(value);
                break;
            case "remove":
            case "delete":
                if (string.IsNullOrWhiteSpace(value))
                {
                    PrintError("âŒ Value required for 'remove' action");
                    PrintInfo("ğŸ’¡ Example: dotnet run bypass remove \"*.example.com\"");
                    return;
                }
                await RemoveFromBypassListAsync(value);
                break;
            case "clear":
                await ClearBypassListAsync();
                break;
            default:
                PrintError($"âŒ Unknown action: {action}");
                PrintInfo("ğŸ’¡ Available actions: show, set, add, remove, clear");
                break;
        }
    }

    static async Task ManageBypassListInteractiveAsync()
    {
        Console.WriteLine();
        PrintHeader("ğŸš« Manage Bypass List");
        
        while (true)
        {
            Console.WriteLine();
            PrintSuccess("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
            PrintSuccess("â•‘   Bypass List Operations:   â•‘");
            PrintSuccess("â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£");
            Console.WriteLine("â•‘  1ï¸âƒ£  Show Bypass List        â•‘");
            Console.WriteLine("â•‘  2ï¸âƒ£  Set/Replace Bypass List â•‘");
            Console.WriteLine("â•‘  3ï¸âƒ£  Add Item to List        â•‘");
            Console.WriteLine("â•‘  4ï¸âƒ£  Remove Item from List   â•‘");
            Console.WriteLine("â•‘  5ï¸âƒ£  Clear All List          â•‘");
            Console.WriteLine("â•‘  6ï¸âƒ£  Back to Main Menu       â•‘");
            PrintSuccess("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
            Console.Write("\nğŸ‘‰ Your choice (1-6): ");

            string? choice = Console.ReadLine();

            switch (choice)
            {
                case "1":
                    ShowBypassList();
                    break;
                case "2":
                    Console.Write("\nğŸ“ Enter bypass list (separate with ;): ");
                    string? newList = Console.ReadLine();
                    if (!string.IsNullOrWhiteSpace(newList))
                    {
                        await SetBypassListAsync(newList);
                    }
                    else
                    {
                        PrintError("âŒ Bypass list cannot be empty!");
                    }
                    break;
                case "3":
                    Console.Write("\nâ• Enter item to add: ");
                    string? addItem = Console.ReadLine();
                    if (!string.IsNullOrWhiteSpace(addItem))
                    {
                        await AddToBypassListAsync(addItem);
                    }
                    else
                    {
                        PrintError("âŒ Item cannot be empty!");
                    }
                    break;
                case "4":
                    Console.Write("\nâ– Enter item to remove: ");
                    string? removeItem = Console.ReadLine();
                    if (!string.IsNullOrWhiteSpace(removeItem))
                    {
                        await RemoveFromBypassListAsync(removeItem);
                    }
                    else
                    {
                        PrintError("âŒ Item cannot be empty!");
                    }
                    break;
                case "5":
                    Console.Write("\nâš ï¸  Are you sure you want to clear all bypass list? (y/n): ");
                    string? confirm = Console.ReadLine();
                    if (confirm?.ToLower() == "y" || confirm?.ToLower() == "yes")
                    {
                        await ClearBypassListAsync();
                    }
                    else
                    {
                        PrintInfo("â„¹ï¸  Operation cancelled");
                    }
                    break;
                case "6":
                    return;
                default:
                    PrintError("âŒ Invalid choice!");
                    break;
            }
        }
    }

    static void ShowBypassList()
    {
        try
        {
            Console.WriteLine();
            PrintHeader("ğŸ“‹ Current Bypass List");

            using RegistryKey? key = Registry.CurrentUser.OpenSubKey(ProxyRegistryPath);
            
            if (key == null)
            {
                PrintError("âŒ Cannot access proxy registry");
                return;
            }

            object? proxyOverride = key.GetValue("ProxyOverride");

            Console.WriteLine();
            if (proxyOverride == null || string.IsNullOrWhiteSpace(proxyOverride.ToString()))
            {
                Console.WriteLine("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
                PrintWarning("â•‘       âš ï¸  NO BYPASS LIST CONFIGURED            â•‘");
                Console.WriteLine("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
                return;
            }

            string bypassList = proxyOverride.ToString()!;
            string[] items = bypassList.Split(';');

            Console.WriteLine("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
            PrintSuccess($"â•‘  Total Items: {items.Length,-34}â•‘");
            Console.WriteLine("â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£");
            
            for (int i = 0; i < items.Length; i++)
            {
                Console.ForegroundColor = ConsoleColor.Cyan;
                Console.WriteLine($"â•‘  {i + 1,2}. {items[i],-43}â•‘");
                Console.ResetColor();
            }
            
            Console.WriteLine("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
        }
        catch (Exception ex)
        {
            PrintError($"âŒ Error: {ex.Message}");
        }
    }

    static async Task SetBypassListAsync(string bypassList)
    {
        try
        {
            Console.WriteLine();
            PrintHeader("âš™ï¸  Setting Bypass List");

            using RegistryKey? key = Registry.CurrentUser.OpenSubKey(ProxyRegistryPath, true);
            
            if (key == null)
            {
                PrintError("âŒ Cannot access proxy registry");
                return;
            }

            key.SetValue("ProxyOverride", bypassList);

            Console.WriteLine();
            Console.WriteLine("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
            PrintSuccess("â•‘       âœ… BYPASS LIST SET!                       â•‘");
            Console.WriteLine("â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£");
            Console.ForegroundColor = ConsoleColor.Cyan;
            Console.WriteLine($"â•‘  ğŸš« List: {bypassList,-38}â•‘");
            Console.ResetColor();
            Console.WriteLine("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");

            // Notify system
            Console.WriteLine();
            PrintInfo("â³ Notifying system...");
            if (NotifyProxyChange())
            {
                PrintSuccess("âœ… System notified successfully! ğŸš€");
            }

            // Send notifications
            await SendNotificationsAsync("Bypass List Updated", $"New list: {bypassList}");
        }
        catch (Exception ex)
        {
            PrintError($"âŒ Error: {ex.Message}");
        }
    }

    static async Task AddToBypassListAsync(string item)
    {
        try
        {
            Console.WriteLine();
            PrintHeader("â• Adding to Bypass List");

            using RegistryKey? key = Registry.CurrentUser.OpenSubKey(ProxyRegistryPath, true);
            
            if (key == null)
            {
                PrintError("âŒ Cannot access proxy registry");
                return;
            }

            object? proxyOverride = key.GetValue("ProxyOverride");
            string currentList = proxyOverride?.ToString() ?? "";

            // Check if item already exists
            string[] items = currentList.Split(';', StringSplitOptions.RemoveEmptyEntries);
            if (items.Any(i => i.Trim().Equals(item.Trim(), StringComparison.OrdinalIgnoreCase)))
            {
                Console.WriteLine();
                Console.WriteLine("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
                PrintWarning("â•‘       âš ï¸  ITEM ALREADY EXISTS                  â•‘");
                Console.WriteLine("â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£");
                Console.ForegroundColor = ConsoleColor.Yellow;
                Console.WriteLine($"â•‘  Item: {item,-41}â•‘");
                Console.ResetColor();
                Console.WriteLine("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
                return;
            }

            // Add new item
            string newList = string.IsNullOrWhiteSpace(currentList) 
                ? item 
                : $"{currentList};{item}";

            key.SetValue("ProxyOverride", newList);

            Console.WriteLine();
            Console.WriteLine("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
            PrintSuccess("â•‘       âœ… ITEM ADDED!                            â•‘");
            Console.WriteLine("â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£");
            Console.ForegroundColor = ConsoleColor.Cyan;
            Console.WriteLine($"â•‘  â• Added: {item,-38}â•‘");
            Console.ResetColor();
            Console.WriteLine("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");

            // Notify system
            Console.WriteLine();
            PrintInfo("â³ Notifying system...");
            if (NotifyProxyChange())
            {
                PrintSuccess("âœ… System notified successfully! ğŸš€");
            }

            // Send notifications
            await SendNotificationsAsync("Bypass Item Added", $"Added: {item}");
        }
        catch (Exception ex)
        {
            PrintError($"âŒ Error: {ex.Message}");
        }
    }

    static async Task RemoveFromBypassListAsync(string item)
    {
        try
        {
            Console.WriteLine();
            PrintHeader("â– Removing from Bypass List");

            using RegistryKey? key = Registry.CurrentUser.OpenSubKey(ProxyRegistryPath, true);
            
            if (key == null)
            {
                PrintError("âŒ Cannot access proxy registry");
                return;
            }

            object? proxyOverride = key.GetValue("ProxyOverride");
            
            if (proxyOverride == null || string.IsNullOrWhiteSpace(proxyOverride.ToString()))
            {
                Console.WriteLine();
                Console.WriteLine("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
                PrintWarning("â•‘       âš ï¸  BYPASS LIST IS EMPTY                 â•‘");
                Console.WriteLine("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
                return;
            }

            string currentList = proxyOverride.ToString()!;
            string[] items = currentList.Split(';', StringSplitOptions.RemoveEmptyEntries);

            // Find and remove item (case insensitive)
            var remainingItems = items.Where(i => !i.Trim().Equals(item.Trim(), StringComparison.OrdinalIgnoreCase)).ToArray();

            if (remainingItems.Length == items.Length)
            {
                Console.WriteLine();
                Console.WriteLine("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
                PrintWarning("â•‘       âš ï¸  ITEM NOT FOUND                       â•‘");
                Console.WriteLine("â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£");
                Console.ForegroundColor = ConsoleColor.Yellow;
                Console.WriteLine($"â•‘  Item: {item,-41}â•‘");
                Console.ResetColor();
                Console.WriteLine("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
                return;
            }

            string newList = string.Join(";", remainingItems);
            
            if (string.IsNullOrWhiteSpace(newList))
            {
                key.DeleteValue("ProxyOverride", false);
            }
            else
            {
                key.SetValue("ProxyOverride", newList);
            }

            Console.WriteLine();
            Console.WriteLine("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
            PrintSuccess("â•‘       âœ… ITEM REMOVED!                          â•‘");
            Console.WriteLine("â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£");
            Console.ForegroundColor = ConsoleColor.Cyan;
            Console.WriteLine($"â•‘  â– Removed: {item,-36}â•‘");
            if (string.IsNullOrWhiteSpace(newList))
            {
                Console.WriteLine($"â•‘  ğŸš« New List: (empty){"",29}â•‘");
            }
            else
            {
                Console.WriteLine($"â•‘  ğŸš« New List: {newList,-34}â•‘");
            }
            Console.ResetColor();
            Console.WriteLine("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");

            // Notify system
            Console.WriteLine();
            PrintInfo("â³ Notifying system...");
            if (NotifyProxyChange())
            {
                PrintSuccess("âœ… System notified successfully! ğŸš€");
            }

            // Send notifications
            await SendNotificationsAsync("Bypass Item Removed", $"Removed: {item}");
        }
        catch (Exception ex)
        {
            PrintError($"âŒ Error: {ex.Message}");
        }
    }

    static async Task ClearBypassListAsync()
    {
        try
        {
            Console.WriteLine();
            PrintHeader("ğŸ—‘ï¸  Clearing Bypass List");

            using RegistryKey? key = Registry.CurrentUser.OpenSubKey(ProxyRegistryPath, true);
            
            if (key == null)
            {
                PrintError("âŒ Cannot access proxy registry");
                return;
            }

            key.DeleteValue("ProxyOverride", false);

            Console.WriteLine();
            Console.WriteLine("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
            PrintSuccess("â•‘       âœ… BYPASS LIST CLEARED!                   â•‘");
            Console.WriteLine("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");

            // Notify system
            Console.WriteLine();
            PrintInfo("â³ Notifying system...");
            if (NotifyProxyChange())